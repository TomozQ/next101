# Next.jsの機能
<br>
<br>

## リンク
___
### Linkコンポーネント
* アプリ内の他のページへ遷移するために使用
* Linkコンポーネントを使用してページを遷移した場合は、通常のページ遷移のように遷移先のページのHTMLファイルなどを取得して描画するのではなく、クライアントサイドで新しいページを描画する。
* 新しいページを描画するために必要なデータはあらかじめ非同期に取得されている。
* 高速なページ遷移が可能
* クエリパラメータも指定する場合、hrefの文字列でそのまま指定する以外にオブジェクトを使っても指定できる。
* a要素の代わりにbuttonなどを使用すると、Linkの子コンポーネントからonClickコールバックが渡され、コールバックが呼ばれるとページが遷移する。
<br>
<br>

### useRouter

```javascript
import { useRouter } from 'next/router'

const router = useRouter()

// 呼ぶとページがリロードされる。
router.reload()

// 呼ぶと前のページに戻る
router.back()

// 遷移開始時のイベントを購読する
router.events.on('routeChangeStart', (url, { shallow }) => {
  // url には遷移先のパスが与えられる
  // shallowはシャロールーティング（パスのみが置き換わる遷移）の場合はtrueになる。
})

// 遷移完了時のイベントを購読する
router.events.on('routeChangeComplete', (url, { shwllow }) => {
  // url には遷移先のパスが与えられる
  // shallowはシャロールーティング（パスのみが置き換わる遷移）の場合はtrueになる。
})
```
<br>
<br>

## 画像の表示
___
Next.jsはビルトインの機能で画像のパフォーマンスを最適化できる。<br>
近年Webページ内のコンテンツで画像が占める割合は大きくなってきているため、パフォーマス向上のため画像表示の最適化は非常に重要
<br>

### Imageコンポーネント
* Next.jsで画像を表示するにはnext/imageのImageコンポーネントを使用する
* imgタグではなくImageコンポーネントを利用することで、画像を読み込む際にサーバーサイドで画像の最適化を行う
* Imageはimgを拡張したようなコンポーネントで、渡す値（属性）は基本的にはimgタグと同様のものを渡す
* しかしwidthとheightを渡さないとエラーが発生する
* 開発者ツールからimgタグとImageコンポーネントを比較すると、imgタグの方は静的ファイルとして提供されている画像のパスを指しているが、Imageコンポーネントで表示している方は `/_next/image`以下を参照していることを確認できる。
* またファイルサイズは元の画像に比べると半分以下になっている。
<br>

Imageコンポーネントを使用すると、ブラウザの情報を元に最適化した画像を提供する。
例えば

1. WebP対応ブラウザにはWebP形式の画像を提供
2. ブラウザの画面サイズに応じて適切な大きさの画像を提供

画像の描画方法についてもいくつか異なる

3. Imageコンポーネントは初期段階でビューポートに表示されていない画像は描画せず、スクロールしてビューポートに近づいた段階で画像の取得・描画を開始する（レイジーロード）。
4. あらかじめ表示領域を確保し、表示後のレイアウトが崩れることを防ぐ

その他Imageコンポーネントはいくつかのパラメータをpropsに渡せる。

___
__layout__ ではビューポートの変化に応じて画像をリサイズするかを設定でき、defaultは __intrinsic__
* __intrinsic__ はビューポートが画像より小さい時、ビューポートに応じてリサイズした画像を表示
* __responsive__ はビューポートに応じてリサイズした画像を表示
* __fixed__ はwidthとheightに準拠し、ビューポートの大きさによらず同じサイズの画像を表示
* __fill__ は親要素に合わせた画像を表示
___
<br>

___
__placeholder__ では画像読み込み中に表示する内容を指定できる。
* __empty__ を指定すると画像の領域のみ確保し何も表示しない
* __blur__ を指定するとぼかし画像を表示

import文で読み込んだローカル画像の場合はぼかし画像が自動生成されて表示されるが、パスで指定した場合や外部の画像の場合はblurDataURLに表示するぼかし画像のURLを指定する必要がある。
___

<br>
外部リソースの画像を表示する場合も、srcに文字列のパスを指定できる。この時2点に注意する必要がある

1. 静的ファイルとは違い画像サイズを事前に取得できないためlayoutがfill以外の場合はwidthとheightを与えてサイズを指定する必要がある
2. 外部リソースの画像を表示する場合、デフォルトでは最適化した画像を表示できない。そのため next.config.js のdomainsに最適化を許可する画像のドメインを追加するか、Imageコンポーネントのunoptimizedにtrueを渡して最適化を無効化する必要がある。
<br>
<br>

## APIルート
___
pages/api以下においたファイルではAPI（JSONベースのWeb API）を定義する。
<br>
ページと同様にファイルの場所によってパスが決まる

* ページで使う簡易的なAPIの実装、プロキシとして利用できる
* ビルド時はこのAPIを使うことができないため、SSGのgetStaticPathsやgetStaticPropsから呼ぶことはできない。
<br>
<br>

## 環境変数 / コンフィグ
___
Next.jsはビルトインで環境変数のための.envファイルを処理できる。<br>
プロジェクトルートにおいてある環境変数ファイル.envは自動で読み込まれ、コード上で参照できる。<br>
.envを含め次の形式のファイルを参照できる。

* __.env__
* __.env.local__
* __.env.${環境名}__
* __.env.${環境名}.local__

.localがついているものは __.gitignore__ に追加されることを意図しており、APIキーなどの後悔したくない値を保存するために使用する<br>
.envと.env.localは環境を問わず、常に使用できる。<br>
__.env.development__ と __.env.development.local__ は開発サーバーを動かすときに、__.env.production__ や __.env.production.local__ はビルド時や本番環境で動かすときに使用する
<br>
読み込まれた環境変数は、サーバーサイドで実行する処理から参照できる。つまり、getServerSidePropsなどの関数やAPIハンドラ、ビルド時にSSGのページを描画するとき、SSRのページをサーバーサイドで描画するときに環境変数の値を参照できる。<br>
再描画などでクライアントサイドでアクセスした場合は __undefined__ になる。
クライアントサイドでもアクセスしたい値に関しては、環境変数の名前の頭に __NEXT_PUBLIC___ をつける